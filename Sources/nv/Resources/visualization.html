<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Build Visualization</title>

  <!-- bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Visualization Library -->
  <script src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>

  <style>
    body {
      background: #0f172a;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      color: white;
    }

    .navbar {
      background: rgba(15, 23, 42, 0.95) !important;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      color: white !important;
      font-weight: 600;
      font-size: 1.25rem;
    }

    small.text-light {
      color: rgba(148, 163, 184, 0.8) !important;
      font-size: 0.85rem;
    }

    .stat-card {
      transition: transform 0.2s ease;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .stat-card .card-title {
      color: rgba(148, 163, 184, 0.9);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .card {
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .card-header {
      background: linear-gradient(135deg, #3b82f6, #10b981);
      color: white;
      border-radius: 12px 12px 0 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    }

    .card-header h4 {
      margin-bottom: 0.25rem;
      font-weight: 600;
    }

    .card-header small {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.85rem;
    }

    .card-body {
      background: rgba(15, 23, 42, 0.7);
      color: white;
    }

    h2 {
      color: white;
      font-weight: 600;
    }

    .text-primary {
      color: #60a5fa !important;
    }

    .text-success {
      color: #34d399 !important;
    }

    .text-info {
      color: #38bdf8 !important;
    }

    .text-secondary {
      color: #94a3b8 !important;
    }

    .text-warning {
      color: #fbbf24 !important;
    }

    .text-danger {
      color: #f87171 !important;
    }

    .text-dark {
      color: #e2e8f0 !important;
    }

    .text-muted {
      color: #94a3b8 !important;
    }

    .hover-tooltip {
      position: fixed;
      background: linear-gradient(135deg, #3b82f6, #10b981);
      color: white;
      padding: 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      min-width: 280px;
      max-width: 400px;
      z-index: 1100;
      pointer-events: none;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.15s ease;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .hover-tooltip.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .tooltip-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .tooltip-icon {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 6px;
      margin-right: 10px;
    }

    .tooltip-title {
      font-weight: 600;
      line-height: 1.3;
      word-break: break-word;
    }

    .tooltip-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .tooltip-item {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 6px;
      padding: 8px;
    }

    .tooltip-label {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .tooltip-value {
      color: white;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .tooltip-full-path {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
    }

    .tooltip-full-path .tooltip-value {
      font-size: 0.8rem;
      line-height: 1.4;
      word-break: break-all;
      white-space: pre-wrap;
    }

    @media (max-width: 768px) {
      .hover-tooltip {
        min-width: 250px;
        max-width: 90vw;
        font-size: 0.85rem;
      }

      .tooltip-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }

    .table {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: white;
      margin-bottom: 0;
    }

    .table thead th {
      background: rgba(15, 23, 42, 0.95);
      font-weight: 600;
      padding: 1rem 0.75rem;
      border: none;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      color: white;
    }

    .table tbody td,
    .table tbody th {
      padding: 0.75rem;
      vertical-align: middle;
      background: rgba(15, 23, 42, 0.8);
      border: none;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      color: white;
    }

    .table tbody tr:hover td,
    .table tbody tr:hover th {
      background: rgba(59, 130, 246, 0.2);
    }

    .table tbody tr:last-child td,
    .table tbody tr:last-child th {
      border-bottom: none;
    }

    .table-striped tbody tr:nth-of-type(odd) td,
    .table-striped tbody tr:nth-of-type(odd) th {
      background: rgba(15, 23, 42, 0.85);
    }

    #visualization {
      min-height: 400px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .vis-timeline {
      border: none !important;
      background: transparent !important;
    }

    .vis-panel {
      border: none !important;
    }

    .vis-labelset .vis-label {
      background: rgba(15, 23, 42, 0.95) !important;
      border: none !important;
      border-right: 1px solid rgba(148, 163, 184, 0.3) !important;
      color: white !important;
      font-weight: 500 !important;
    }

    .vis-item {
      border-radius: 3px !important;
      border: 1px solid rgba(148, 163, 184, 0.4) !important;
      box-shadow: none !important;
    }

    .vis-item:hover {
      border-color: rgba(148, 163, 184, 0.6) !important;
    }

    .vis-item.vis-selected {
      box-shadow: 0 0 0 2px #3b82f6 !important;
    }

    .vis-time-axis {
      border: none !important;
      background: rgba(15, 23, 42, 0.8) !important;
    }

    .vis-time-axis .vis-text {
      color: rgba(255, 255, 255, 0.9) !important;
      font-size: 0.85rem !important;
    }

    .vis-time-axis .vis-grid.vis-minor {
      border-color: rgba(148, 163, 184, 0.2) !important;
    }

    .vis-time-axis .vis-grid.vis-major {
      border-color: rgba(148, 163, 184, 0.3) !important;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-graph-up"></i>
        &nbsp; Build Visualization
      </a>
      <small class="text-light"> Generated by <tt>nv visualize</tt></small>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Summary Statistics -->
    <div class="row mb-4">
      <div class="col-12">
        <h2 class="mb-3">
          <i class="bi bi-speedometer2"></i>
          &nbsp; Build Overview
        </h2>
      </div>
      <div class="col-md-2 col-sm-4 col-6 mb-3">
        <div class="card stat-card h-100">
          <div class="card-body text-center">
            <i class="bi bi-bullseye display-6 text-primary"></i>
            <h5 class="card-title mt-2">Targets</h5>
            <h3 id="targets" class="text-primary">{{& targets}}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-2 col-sm-4 col-6 mb-3">
        <div class="card stat-card h-100">
          <div class="card-body text-center">
            <i class="bi bi-clock display-6 text-secondary"></i>
            <h5 class="card-title mt-2">Wall Time</h5>
            <h3 class="text-secondary">{{& wall_time}}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-2 col-sm-4 col-6 mb-3">
        <div class="card stat-card h-100">
          <div class="card-body text-center">
            <i class="bi bi-cpu display-6 text-success"></i>
            <h5 class="card-title mt-2">CPU Time</h5>
            <h3 class="text-success">{{& cpu_time}}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-2 col-sm-4 col-6 mb-3">
        <div class="card stat-card h-100">
          <div class="card-body text-center">
            <i class="bi bi-speedometer2 display-6 text-info"></i>
            <h5 class="card-title mt-2">Core Utilization</h5>
            <h3 class="text-info">{{& core_count}}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-2 col-sm-4 col-6 mb-3">
        <div class="card stat-card h-100">
          <div class="card-body text-center">
            <i class="bi bi-lightning display-6 text-dark"></i>
            <h5 class="card-title mt-2">Efficiency</h5>
            <h3 id="efficiency" class="text-dark">{{& efficiency}}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-2 col-sm-4 col-6 mb-3">
        <div class="card stat-card h-100">
          <div class="card-body text-center">
            <i class="bi bi-hourglass-split display-6 text-muted"></i>
            <h5 class="card-title mt-2">Average Time</h5>
            <h3 class="text-muted">{{& average_time}}</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Build Timeline -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">
              <i class="bi bi-calendar3"></i>
              &nbsp; Build Timeline
            </h4>
            <small>Hover over timeline items for detailed information</small>
          </div>
          <div class="card-body">
            <div id="visualization"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Bottlenecks -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">
              <i class="bi bi-exclamation-triangle"></i>
              &nbsp; Top Bottlenecks
            </h4>
            <small>Slowest Build Targets</small>
          </div>
          <div class="card-body">
            <table class="table table-striped" style="margin-bottom: 0;">
              <thead>
                <tr>
                  <th scope="col" style="width: 3rem;">#</th>
                  <th scope="col">Target</th>
                  <th scope="col">Duration</th>
                </tr>
              </thead>
              <tbody>
                {{#bottlenecks}}
                <tr>
                  <th scope="row" style="width: 3rem;">{{rank}}</th>
                  <td title="{{full_target}}">{{target}}</td>
                  <td>{{duration}}</td>
                </tr>
                {{/bottlenecks}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hover Tooltip -->
  <div class="hover-tooltip" id="hover-tooltip">
    <div class="tooltip-header">
      <div class="tooltip-icon">
        <i class="bi bi-gear"></i>
      </div>
      <div class="tooltip-title" id="tooltip-title"></div>
    </div>
    <div class="tooltip-grid" id="tooltip-grid">
      <!-- Dynamic content -->
    </div>
    <div class="tooltip-full-path" id="tooltip-full-path">
      <div class="tooltip-label">Full Path</div>
      <div class="tooltip-value" id="tooltip-path-value"></div>
    </div>
  </div>

  <script>
    const base = new Date({{& min_time}});

    const groups = new vis.DataSet([
      {{#groups}}{ id: {{id}}, content: '{{label}}', order: {{id}} }{{^last}},
      {{/last}}{{/groups}}
    ]);

    const items = new vis.DataSet([
      {{#tasks}}{ id: {{id}}, content: '{{content}}', title: '{{title}}', start: {{start}}, end: {{end}}, group: {{group}}, target: '{{target}}', duration: {{duration}} }{{^last}},
      {{/last}}{{/tasks}}
    ]);

    const timeline = new vis.Timeline(document.getElementById('visualization'), items, {
      horizontalScroll: true,
      zoomKey: 'ctrlKey',
      max: {{& max_time}},
      min: {{& min_time}},
      showMajorLabels: false,
      showMinorLabels: true,
      stack: false,
      format: {
        minorLabels: (date) => (date - base) / 1000 + ' s'
      },
      tooltip: {
        followMouse: false,
        overflowMethod: 'cap',
        template: () => ''
      }
    });
    timeline.setGroups(groups);

    const tooltip = document.getElementById('hover-tooltip');
    const tooltipTitle = document.getElementById('tooltip-title');
    const tooltipGrid = document.getElementById('tooltip-grid');
    const tooltipPath = document.getElementById('tooltip-path-value');

    function formatDuration(seconds) {
      if (seconds < 1) return (seconds * 1000).toFixed(0) + ' ms';
      if (seconds < 60) return seconds.toFixed(2) + ' s';
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = (seconds % 60).toFixed(2);
      return minutes + ' m ' + remainingSeconds + ' s';
    }

    function updateTooltipPosition(event) {
      const rect = tooltip.getBoundingClientRect();
      let x = event.clientX + 15;
      let y = event.clientY - 15;

      if (x + rect.width > window.innerWidth) {
        x = event.clientX - rect.width - 15;
      }
      if (y < 0) {
        y = event.clientY + 25;
      }
      if (y + rect.height > window.innerHeight) {
        y = window.innerHeight - rect.height - 10;
      }

      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    }

    timeline.on('itemover', (properties) => {
      const item = items.get(properties.item);
      if (!item) return;

      const duration = (item.end - item.start) / 1000;
      const relativeStart = (item.start - {{& min_time}}) / 1000;
      const relativeEnd = (item.end - {{& min_time}}) / 1000;

      tooltipTitle.textContent = item.content;
      tooltipPath.textContent = item.target;
      tooltipGrid.innerHTML = `
        <div class="tooltip-item">
          <div class="tooltip-label">Start Time</div>
          <div class="tooltip-value">${formatDuration(relativeStart)}</div>
        </div>
        <div class="tooltip-item">
          <div class="tooltip-label">End Time</div>
          <div class="tooltip-value">${formatDuration(relativeEnd)}</div>
        </div>
        <div class="tooltip-item">
          <div class="tooltip-label">Duration</div>
          <div class="tooltip-value">${formatDuration(duration)}</div>
        </div>
      `;

      updateTooltipPosition(properties.event);
      tooltip.classList.add('visible');
    });

    timeline.on('itemout', () => tooltip.classList.remove('visible'));

    document.getElementById('visualization').addEventListener('mousemove', (event) => {
      if (tooltip.classList.contains('visible')) {
        updateTooltipPosition(event);
      }
    });
  </script>
</body>
</html>
